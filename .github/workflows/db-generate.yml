name: Check Database Migration

on:
  pull_request:
    branches: [main, staging]
    paths:
      - 'app/lib/db/schema.ts'
      - 'drizzle/**'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for schema drift
        run: |
          bun drizzle-kit generate
          if [ -n "$(git status drizzle --porcelain)" ]; then
            echo "❌ Schema changes detected but migration not committed!"
            echo ""
            echo "Run locally:"
            echo "  bun drizzle-kit generate"
            echo "  git add drizzle/"
            echo "  git commit -m 'chore: add database migration'"
            echo ""
            git status drizzle
            exit 1
          fi
          echo "✅ Schema and migrations are in sync"
